name: "Action to commit changes to the repository"
inputs:
  token:
    description: "GitHub token"
    required: true
outputs:
  sha:
    description: "SHA of generated commit"
    value: ${{ steps.commit.outputs.sha }}

runs:
  using: "composite"
  steps:
    - name: Check for changes
      id: check
      run: |
        set -x
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" | tee -a $GITHUB_OUTPUT
        else
          echo "has_changes=false" | tee -a $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Determine repository state
      if: steps.check.outputs.has_changes == 'true'
      id: repo-state
      uses: ./.github/workflows/repo-state

    - name: Commit if changed, create a PR if protected
      id: commit
      if: steps.check.outputs.has_changes == 'true'
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
      run: |
        set -x
        protected=${{ steps.repo-state.outputs.protected }}
        foreign=${{ steps.repo-state.outputs.foreign }}
        is_pr=${{ steps.repo-state.outputs.is_pr }}
        if [ "${foreign}" = "true" ]; then
          # https://github.com/krlmlr/actions-sync/issues/44
          echo "Can't push to foreign branch"
          gh issue comment ${{ github.event.pull_request.number }} --body "⚠️ Unable to push changes back to your branch because it is in a forked repository. Please apply the suggested changes manually."
          exit 1
        elif [ "${protected}" = "true" ]; then
          current_branch=$(git branch --show-current)
          new_branch=gha-commit-$(git rev-parse --short HEAD)
          git checkout -b ${new_branch}
          git add .
          git commit -m "chore: Auto-update from GitHub Actions"$'\n'$'\n'"Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          # Force-push, used in only one place
          # Alternative: separate branch names for each usage
          git push -u origin HEAD -f

          existing_pr=$(gh pr list --state open --base main --head ${new_branch} --json number --jq '.[] | .number')
          if [ -n "${existing_pr}" ]; then
            echo "Existing PR: ${existing_pr}"
          else
            gh pr create --base main --head ${new_branch} --title "chore: Auto-update from GitHub Actions" --body "Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          fi

          gh workflow run rcc -f ref=$(git rev-parse HEAD)
          gh pr merge --merge --auto
        else
          git fetch
          if [ -n "${GITHUB_HEAD_REF}" ]; then
            git add .
            git stash save
            git switch ${GITHUB_HEAD_REF}
            git merge origin/${GITHUB_BASE_REF} --no-edit
            git stash pop
          fi
          git add .
          git commit -m "chore: Auto-update from GitHub Actions"$'\n'$'\n'"Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          git push -u origin HEAD

          # Only set output if changed
          echo sha=$(git rev-parse HEAD) >> $GITHUB_OUTPUT
        fi
      shell: bash
